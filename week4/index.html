<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>行ってみたい世界遺産マップ!</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
    <link href="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.2.1/dist/maplibre-gl.js"></script>
</head>
<body>
    <div id="map"></div>
    <script>
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'gsi-english': {
        type: 'raster',
        tiles: [
          'https://cyberjapandata.gsi.go.jp/xyz/english/{z}/{x}/{y}.png'
        ],
        tileSize: 256,
        attribution: '地理院タイル &copy; <a href="https://www.gsi.go.jp/" target="_blank">国土地理院</a>'
      }
    },
    layers: [
      {
        id: 'gsi-english-layer',
        type: 'raster',
        source: 'gsi-english',
        minzoom: 0,
        maxzoom: 18
      }
    ]
  },
  center: [138.0, 36.0], // 日本全体を中心に設定
  zoom: 3 // さらにズームアウト
});

        map.addControl(new maplibregl.NavigationControl());

        // Add functionality to save GeoJSON data to localStorage
        function saveGeoJSONToLocalStorage(data) {
            localStorage.setItem('heritageData', JSON.stringify(data));
        }

        // Load GeoJSON data from localStorage
        function loadGeoJSONFromLocalStorage() {
            const savedData = localStorage.getItem('heritageData');
            return savedData ? JSON.parse(savedData) : null;
        }

        // Modify the map load event to use saved data if available
        map.on('load', function () {
            let heritageData = loadGeoJSONFromLocalStorage();
            if (!heritageData) {
                heritageData = 'world_heritage_dream.geojson'; // Default data source
            }

            // Fetch the GeoJSON data and add it to the map
            fetch('world_heritage_dream.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('GeoJSONデータの読み込みに失敗しました');
                    }
                    return response.json();
                })
                .then(data => {
                    // Add the GeoJSON data as a source
                    map.addSource('heritage', {
                        type: 'geojson',
                        data: data
                    });

                    // Add the layer for the heritage points
                    map.addLayer({
                        id: 'heritage-points',
                        type: 'circle',
                        source: 'heritage',
                        paint: {
                            'circle-radius': 10,
                            'circle-color': [
                                'case',
                                ['boolean', ['get', 'visited'], false], // 訪問済みの場合
                                '#FFD700', // ゴールド色
                                [
                                    'match',
                                    ['get', 'category'],
                                    '文化', '#FF5722',
                                    '自然', '#4CAF50',
                                    '複合', '#2196F3',
                                    /* default */ '#9E9E9E'
                                ]
                            ],
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#000000'
                        }
                    });
                })
                .catch(error => {
                    console.error('GeoJSONデータの読み込みエラー:', error);
                });

            map.on('click', 'heritage-points', function (e) {
                const props = e.features[0].properties;
                const popupContent = `
                    <strong>${props.name}</strong><br>
                    ${props.country}<br>
                    ${props.comment}<br>
                    登録年: ${props.registeredYear}<br>
                    <label>
                        <input type="checkbox" id="visited-checkbox" ${props.visited ? 'checked' : ''}>
                        訪問済み
                    </label>
                    <div id="comment-section" style="margin-top: 10px; ${props.visited ? '' : 'display: none;'}">
                        <textarea id="visit-comment" placeholder="感想を入力してください" style="width: 100%; height: 50px;">${props.visitComment || ''}</textarea>
                    </div>
                    <button id="save-button" style="margin-top: 10px;">保存</button>
                `;
                const popup = new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);

                const checkbox = popup.getElement().querySelector('#visited-checkbox');
                const commentSection = popup.getElement().querySelector('#comment-section');
                const textarea = popup.getElement().querySelector('#visit-comment');
                const saveButton = popup.getElement().querySelector('#save-button');

                // チェックボックスのイベントリスナー
                checkbox.addEventListener('change', function (event) {
                    const visited = event.target.checked;
                    props.visited = visited; // プロパティを更新
                    commentSection.style.display = visited ? 'block' : 'none';
                
                    map.getSource('heritage').setData(map.getSource('heritage')._data); // 地図を更新
                });

                // テキストエリアのイベントリスナー
                textarea.addEventListener('input', function (event) {
                    props.visitComment = event.target.value; // 感想をプロパティに保存
                    map.getSource('heritage').setData(map.getSource('heritage')._data); // 地図を更新
                });

                // 保存ボタンのイベントリスナー
                saveButton.addEventListener('click', function () {
                    // GeoJSONソースに更新されたプロパティを保存
                    map.getSource('heritage').setData(map.getSource('heritage')._data);
                    saveGeoJSONToLocalStorage(map.getSource('heritage')._data); // ローカルストレージに保存
                    alert('保存しました！');
                });
            });

            map.on('mouseenter', 'heritage-points', function () {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'heritage-points', function () {
                map.getCanvas().style.cursor = '';
            });

            // Create a sidebar for displaying the list of heritage sites
            const sidebar = document.createElement('div');
            sidebar.id = 'heritage-sidebar';
            sidebar.style.position = 'fixed';
            sidebar.style.top = '0';
            sidebar.style.left = '0';
            sidebar.style.width = '300px';
            sidebar.style.height = '100%';
            sidebar.style.backgroundColor = 'white';
            sidebar.style.padding = '20px';
            sidebar.style.boxShadow = '2px 0 5px rgba(0, 0, 0, 0.2)';
            sidebar.style.zIndex = '1000';
            sidebar.style.overflowY = 'auto';
            sidebar.style.display = 'none';

            // Add a close button to the sidebar
            const closeSidebarButton = document.createElement('button');
            closeSidebarButton.textContent = '閉じる';
            closeSidebarButton.style.marginBottom = '10px';
            closeSidebarButton.style.cursor = 'pointer';
            closeSidebarButton.addEventListener('click', () => {
                sidebar.style.display = 'none';
            });
            sidebar.appendChild(closeSidebarButton);

            // Add a container for the list of heritage sites
            const sidebarList = document.createElement('ul');
            sidebarList.style.listStyle = 'none';
            sidebarList.style.padding = '0';
            sidebarList.style.margin = '0';
            sidebar.appendChild(sidebarList);

            document.body.appendChild(sidebar);

            // Make the "世界遺産リスト" title clickable
            const listTitle = document.createElement('button');
            listTitle.textContent = '世界遺産リスト';
            listTitle.style.backgroundColor = '#007BFF';
            listTitle.style.color = 'white';
            listTitle.style.border = 'none';
            listTitle.style.padding = '10px';
            listTitle.style.cursor = 'pointer';
            listTitle.style.borderRadius = '5px';
            listTitle.style.marginBottom = '10px';
            listTitle.style.position = 'absolute';
            listTitle.style.top = '10px';
            listTitle.style.left = '10px';
            listTitle.style.zIndex = '1000';
            document.body.appendChild(listTitle);

            // Update the "世界遺産リスト" button to dynamically fetch features from GeoJSON
            listTitle.addEventListener('click', () => {
                sidebarList.innerHTML = ''; // Clear existing items

                const heritageSource = map.getSource('heritage');
                if (!heritageSource || !heritageSource._data) {
                    alert('データがまだ読み込まれていません');
                    return;
                }

                const features = heritageSource._data.features;
                features.forEach(feature => {
                    const props = feature.properties;
                    const coords = feature.geometry.coordinates;

                    const listItem = document.createElement('li');
                    listItem.textContent = `${props.name}（${props.country}）`;
                    listItem.style.cursor = 'pointer';
                    listItem.style.marginBottom = '5px';

                    listItem.addEventListener('click', () => {
                        map.flyTo({
                            center: coords,
                            zoom: 10
                        });
                    });

                    sidebarList.appendChild(listItem);
                });

                sidebar.style.display = 'block'; // Show the sidebar
            });
        });

        // Ensure the list container is always visible
        listContainer.style.display = 'block';

        // Remove the toggle button as it is no longer needed
        const toggleButton = document.getElementById('toggle-place-list');
        if (toggleButton) {
            toggleButton.remove();
        }
    </script>
</body>
</html>
